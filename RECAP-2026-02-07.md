# Snow-Town Session Recap - 2026-02-07

## Use this prompt to continue the project

---

### What Snow-Town Is

Snow-Town is a closed-loop learning ecosystem that wires three existing projects into a feedback triangle:

```
Ultra Magnus ──OutcomeRecord──> Sky-Lynx
     ^                              │
     │                    ImprovementRecommendation
PersonaUpgradePatch                 │
     │                              v
     └──────────── Agent Persona Academy
```

- **Ultra Magnus** (idea pipeline) runs ideas through capture → enrichment → evaluation → review → scaffold → build → publish. When an idea reaches a terminal state, it emits an `OutcomeRecord`.
- **Sky-Lynx** (observer) reads outcome records + weekly usage data, runs Claude analysis, and produces typed `ImprovementRecommendation` objects (each classified by `target_system`: persona, claude_md, or pipeline).
- **Agent Persona Academy** (factory) consumes persona-targeted recommendations. A `persona_upgrader.py` script calls Claude API to generate `PersonaUpgradePatch` objects (JSON Pointer-based YAML diffs), validated against the Academy's persona schema.
- Upgraded personas feed back into Ultra Magnus for the next cycle.

### Key Architectural Choices Made

1. **JSONL as source of truth, SQLite as query layer.** Three append-only JSONL files in `snow-town/data/` are git-tracked. SQLite (`persona_metrics.db`) provides indexed queries but is rebuildable from JSONL via `store.rebuild_sqlite()`. The `.gitignore` excludes `*.db`.

2. **Contracts live in `snow-town/contracts/`, imported via `sys.path`.** All three projects import contracts with `sys.path.insert(0, snow_town_path)`. This works because everything runs on the same EC2 instance. No package publishing needed.

3. **ContractStore dual-writes.** Every `write_outcome()`, `write_recommendation()`, or `write_patch()` call appends to JSONL AND inserts into SQLite in a single operation.

4. **Persona patches default to "proposed" status.** Human review required before applying. `--auto-apply` flag exists for opt-in auto-application of validated patches.

5. **Weekly loop cadence.** `run_loop.sh` orchestrates: Sky-Lynx analyzer → persona upgrader → loop status reporter. Cron config at `snow-town/cron/snow-town` runs Sundays at 2 AM.

6. **Recommendation classification.** Sky-Lynx's `Recommendation` model was extended with `target_system` (persona|claude_md|pipeline), `target_persona` (specific persona ID), and `recommendation_type` (voice_adjustment, framework_addition, etc.). The Claude prompt now requests these fields. The `parse_recommendations()` regex parser was extended (not replaced) to extract them.

7. **Outcome emission hooks in UM.** `repository.py:update_stage()` auto-emits `OutcomeRecord` when stage transitions to PUBLISHED, REJECTED, or DEFERRED. `set_github_url()` also emits for the PUBLISHED path. A manual `um_record_outcome` MCP tool exists for retroactive recording (14 tools total now).

### What Was Built (by file)

**New repo: `~/projects/snow-town/`**
| File | Purpose |
|------|---------|
| `contracts/outcome_record.py` | OutcomeRecord Pydantic model with PipelineTrace, TerminalOutcome |
| `contracts/improvement_recommendation.py` | ImprovementRecommendation with RecommendationType, TargetScope, EvidenceBasis |
| `contracts/persona_upgrade_patch.py` | PersonaUpgradePatch with PersonaFieldPatch, PatchOperation |
| `contracts/store.py` | ContractStore: dual-write JSONL + SQLite, query methods, rebuild |
| `contracts/__init__.py` | Re-exports all contract types |
| `schemas/*.v1.json` | JSON Schema exports generated from Pydantic models |
| `data/*.jsonl` | Empty append-only data files (git-tracked) |
| `scripts/persona_upgrader.py` | Reads persona recs, calls Claude API, generates validated YAML patches |
| `scripts/loop_status.py` | Reports feedback loop health: pending counts, oldest items, cycle count |
| `scripts/run_loop.sh` | Orchestrates: SL analyzer → persona upgrader → status report |
| `cron/snow-town` | Cron config for weekly Sunday 2AM execution |
| `tests/test_contracts/` | 33 tests: schema validation, roundtrip serialization, invariant enforcement, store ops |

**Modified: `~/projects/ultra-magnus/mcp-server/src/ultra_magnus_mcp/`**
| File | Change |
|------|--------|
| `repository.py` | Added snow-town imports, `_emit_outcome_record()`, `record_outcome_manual()`, hooks in `update_stage()` and `set_github_url()` |
| `server.py` | Added `um_record_outcome` tool + handler (tool #14) |

**Modified/Created: `~/projects/sky-lynx/src/sky_lynx/`**
| File | Change |
|------|--------|
| `outcome_reader.py` | **NEW** - Reads OutcomeRecords from JSONL, builds digest summaries |
| `claude_client.py` | Extended `Recommendation` with `target_system`, `target_persona`, `recommendation_type`; updated `build_analysis_prompt()` to include outcome digest and request classification; extended `parse_recommendations()` to extract new fields; updated `analyze_insights()` signature |
| `report_writer.py` | Added `write_recommendations_sidecar()` - writes JSON sidecar file + appends to snow-town JSONL store; added `_to_contract_recommendation()` converter |
| `analyzer.py` | Wired `outcome_reader` into `run_analysis()` pipeline |

**Deleted from `~/projects/ultra-magnus/`**
- `idea-factory/` - Legacy FastAPI backend (~80 files)
- `idea-factory-dashboard/` - Superseded vanilla JS dashboard (~16 files)
- `idea-catcher/src/idea_catcher/processor.py` - Dead batch processor

### Current Git State

| Repo | Status |
|------|--------|
| `snow-town` | **Fully committed** (3 commits on master) |
| `ultra-magnus` | **UNCOMMITTED** - deletions + repository.py/server.py modifications are staged but not committed |
| `sky-lynx` | **UNCOMMITTED** - 3 modified files + 1 new file (outcome_reader.py) not committed |

### Test State

| Repo | Tests | Status |
|------|-------|--------|
| `snow-town` | 33 contract tests | All passing |
| `sky-lynx` | 28 existing tests | All passing (no regressions) |
| `ultra-magnus` | No tests (MCP server) | Imports verified OK, 14 tools load |

### Known Issues

1. **Sky-Lynx test side effect.** `test_report_writer.py` fixtures trigger `write_recommendations_sidecar()` which writes to the production `snow-town/data/improvement_recommendations.jsonl`. The JSONL and SQLite should be cleaned after running Sky-Lynx tests: `echo -n > ~/projects/snow-town/data/improvement_recommendations.jsonl && rm -f ~/projects/snow-town/data/persona_metrics.db`

2. **No end-to-end proof yet.** The loop has been tested in dry-run mode. No real `OutcomeRecord` exists because no idea has been pushed through UM to a terminal state since the hooks were added. The first real cycle requires: process an idea → reach terminal state → run Sky-Lynx → run persona upgrader.

3. **Cron not installed.** The cron file exists at `snow-town/cron/snow-town` but hasn't been copied to `/etc/cron.d/`. The old Sky-Lynx cron at `/etc/cron.d/sky-lynx` still points to the standalone Sky-Lynx analyzer.

---

## TODO: What Comes Next

### Immediate (complete the session's work)

- [ ] **Commit Ultra Magnus changes.** The deletions + repository.py/server.py modifications need to be committed. Review the diff carefully - it's large due to the legacy directory deletions.
- [ ] **Commit Sky-Lynx changes.** The 3 modified files + new outcome_reader.py need to be committed.
- [ ] **Clean JSONL test artifacts.** Empty `snow-town/data/improvement_recommendations.jsonl` and remove `persona_metrics.db` after test runs.
- [ ] **Fix test side effect.** Either mock the ContractStore in Sky-Lynx's `test_report_writer.py` or use a temp directory for the store during tests.

### Prove the Loop (Phase 5 completion)

- [ ] **Generate first real OutcomeRecord.** Process an existing idea through UM to a terminal state (publish, reject, or defer). Verify `snow-town/data/outcome_records.jsonl` gets a line.
- [ ] **Run Sky-Lynx with real outcomes.** Execute `python -m sky_lynx.analyzer --no-pr` and verify the JSON sidecar and JSONL both get recommendations with `target_system` classification.
- [ ] **Run persona upgrader with real recommendations.** If any recommendations target `persona`, run `python scripts/persona_upgrader.py` and verify patch generation + validation.
- [ ] **Run full loop end-to-end.** `./scripts/run_loop.sh` without `--dry-run`.
- [ ] **Trace one complete cycle.** Document: Idea #X → OutcomeRecord → Recommendation Y → Persona Patch Z.

### Activate Automation

- [ ] **Install cron.** `sudo cp ~/projects/snow-town/cron/snow-town /etc/cron.d/ && sudo systemctl restart cron`
- [ ] **Retire old cron.** `sudo rm /etc/cron.d/sky-lynx` (snow-town's run_loop.sh replaces it)
- [ ] **Create log rotation.** Add logrotate config for `/var/log/snow-town/loop.log`

### Phase 6: Full Rename (Deferred)

- [ ] Decide naming convention (kebab-case? snake_case?)
- [ ] Present full rename map: GitHub repos, directories, package names, internal path references, cron paths, MCP config references
- [ ] Consolidate all repos to `m2ai-portfolio` GitHub org (ultra-magnus currently in MatthewSnow2)
- [ ] Execute renames with `gh repo rename`
- [ ] Update all cross-references (Sky-Lynx hardcodes Academy persona path, etc.)

### Phase 7: Visualization (Deferred)

- [ ] Design dashboard showing items flowing through the loop
- [ ] React app reading from JSONL + SQLite
- [ ] Pipeline status, recommendation queue, patch history, loop health metrics
- [ ] Pure observability - no state mutation

### Hardening

- [ ] Add `--since` flag to `outcome_reader.py` to filter by date range (avoid reprocessing old records)
- [ ] Add deduplication to `write_recommendations_sidecar()` (currently writes every time tests run)
- [ ] Add persona upgrader tests (mock Claude API response)
- [ ] Add integration test: write OutcomeRecord → read in outcome_reader → verify digest format
- [ ] Consider adding `contract_version` migration logic for future schema changes
